// Minimal schema for job-worker
// Only includes models needed for job processing
// IMPORTANT: This must match the main frontend schema exactly!

generator client {
    provider = "prisma-client-js"
    output   = "../generated/prisma"
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

enum GenerationJobStatus {
    PENDING
    GENERATING_STORY
    GENERATING_IMAGES
    ASSEMBLING_PDF
    COMPLETED
    FAILED
}

enum BookStatus {
    PREVIEW_GENERATING
    PREVIEW_READY
    IN_PROGRESS
    COMPLETING
    COMPLETED
    FAILED
}

enum AgeCategory {
    AGE_0_2
    AGE_3_5
    AGE_6_9
    AGE_10_PLUS
}

enum BookTheme {
    EDUCATIONAL
    FAIRY_TALES
    ADVENTURE
    ACTIVITIES
    WORLDS
    STORIES
    HOLIDAYS
    FAMILY
}

enum StorySubject {
    IN_THE_JUNGLE
    THE_SAVANNA
    DEEP_IN_THE_OCEAN
    AT_THE_NORTH_POLE
    CANDY_LAND
    MAGICAL_FOREST
    FAIRY_KINGDOM
    THE_MIDDLE_AGES
    THE_PREHISTORIC_AGE
    THE_WILD_WEST
    THE_VIKINGS
    ANCIENT_EGYPT
    ANCIENT_GREECE
    ANCIENT_ROME
    ARABIAN_NIGHTS_1001
    IN_SPACE
    IN_THE_FUTURE
    ON_MARS
    SAMARKAND_HISTORY
    BUKHARA_TALES
    KHIVA_LEGENDS
    SILK_ROAD_ADVENTURE
    UZBEK_CUISINE
    NAVRUZ_CELEBRATION
    UZBEK_FAIRY_TALES
    AMIR_TEMUR_ERA
    TASHKENT_MODERN
    FERGANA_VALLEY
    DESERT_KYZYLKUM
    MOUNTAIN_TIEN_SHAN
}

enum IllustrationStyle {
    // Main 3 styles (recommended)
    ANIMATION_3D
    FANTASY_STORYBOOK
    SEMI_REALISTIC

    // Additional styles (legacy)
    GEOMETRIC
    WATERCOLOR
    GOUACHE
    PICTURE_BOOK
    BLOCK_WORLD
    SOFT_ANIME
    COLLAGE
    CLAY_ANIMATION
    KAWAII
    COMIC_BOOK
    STICKER_ART
}

model GenerationJob {
    id           String              @id @default(cuid())
    bookId       String              @unique
    status       GenerationJobStatus @default(PENDING)
    progress     Int                 @default(0)
    errorMessage String?             @db.Text
    retryCount   Int                 @default(0)
    createdAt    DateTime            @default(now())
    updatedAt    DateTime            @updatedAt
    completedAt  DateTime?

    book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

    @@index([status, createdAt])
}

model Book {
    id           String     @id @default(cuid())
    userId       String
    childInputId String
    genreId      String
    status       BookStatus @default(PREVIEW_GENERATING)

    // Customization
    ageCategory       AgeCategory?
    theme             BookTheme?
    subject           StorySubject?
    illustrationStyle IllustrationStyle @default(ANIMATION_3D)

    // Character reference
    characterReferenceUrl String?

    // PDF
    pdfUrl String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    childInput    ChildInput     @relation(fields: [childInputId], references: [id])
    genre         Genre          @relation(fields: [genreId], references: [id])
    pages         Page[]
    generationJob GenerationJob?

    @@index([userId])
    @@index([status])
}

model ChildInput {
    id       String  @id @default(cuid())
    name     String
    age      Int?
    gender   String?
    photoUrl String
    photoKey String
    userId   String

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    books Book[]
}

model Genre {
    id          String  @id @default(cuid())
    nameUz      String  @unique
    nameRu      String
    nameEn      String
    description String
    iconName    String
    sortOrder   Int     @default(0)
    isActive    Boolean @default(true)

    books Book[]

    @@index([isActive, sortOrder])
}

model Page {
    id                    String   @id @default(cuid())
    bookId                String
    pageNumber            Int
    text                  String   @db.Text
    sceneDescription      String   @db.Text
    imageUrl              String?
    backgroundImageUrl    String?
    replicatePredictionId String?
    createdAt             DateTime @default(now())
    updatedAt             DateTime @updatedAt

    book Book @relation(fields: [bookId], references: [id], onDelete: Cascade)

    @@unique([bookId, pageNumber])
    @@index([bookId, pageNumber])
}
